import streamlit as st
import numpy as np
import cv2
from PIL import Image

# рокропройрпНрокро╛роЯрпНроЯро┐ройрпН родро▓рпИрокрпНрокрпБ
st.title("ЁЯФм роорпЗроорпНрокроЯрпНроЯ родрпЛро▓рпН роиро┐ро▒ рооро╛ро▒рпНро▒ро┐ (Advanced Skin Tone Changer)")
st.subheader("роорпБроХродрпНродрпИроХрпН роХрогрпНроЯро▒ро┐роирпНродрпБ роХрпБро▒ро┐рокрпНрокро┐роЯрпНроЯ рокроХрпБродро┐ропро┐ро▓рпН роиро┐ро▒ рооро╛ро▒рпНро▒родрпНродрпИроЪрпН роЪрпЖропро▓рпНрокроЯрпБродрпНродрпБродро▓рпН")
st.markdown("---")

# Haar Cascade XML роХрпЛрокрпНрокро┐ройрпН рокрпЖропро░рпН
CASCADES_FILE = "haarcascade_frontalface_default.xml" 

# роорпБроХродрпНродрпИроХрпН роХрогрпНроЯро▒ро┐ропрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпНроЯрпИроЪрпН роЪро░ро┐рокро╛ро░рпНродрпНродро▓рпН
if not cv2.CascadeClassifier(CASCADES_FILE).empty():
    st.info("роорпБроХродрпНродрпИроХрпН роХрогрпНроЯро▒ро┐ропрпБроорпН роХрпЛрокрпНрокрпБ (XML) ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХ роПро▒рпНро▒рокрпНрокроЯрпНроЯродрпБ.")
else:
    st.error(f"рокро┐ро┤рпИ: '{CASCADES_FILE}' роХрпЛрокрпНрокрпБ роХро╛рогро╡ро┐ро▓рпНро▓рпИ роЕро▓рпНро▓родрпБ рокро┐ро┤рпИропро╛роХ роЙро│рпНро│родрпБ. роЙроЩрпНроХро│рпН роХрпЛрокрпНрокрпБро▒рпИропро┐ро▓рпН роЪро░ро┐ропро╛роХ ро╡рпИроХрпНроХро╡рпБроорпН.")
    st.stop() # роХрпЛрокрпНрокрпБ роЗро▓рпНро▓ро╛ро╡ро┐роЯрпНроЯро╛ро▓рпН роЪрпЖропро▓рпНрокро╛роЯрпНроЯрпИ роиро┐ро▒рпБродрпНродрпБ

# рокроЯродрпНродрпИрокрпН рокродро┐ро╡рпЗро▒рпНро▒рпБродро▓рпН
uploaded_file = st.file_uploader("рокроЯродрпНродрпИрокрпН рокродро┐ро╡рпЗро▒рпНро▒ро╡рпБроорпН (Upload an Image)", type=["jpg", "jpeg", "png"])

if uploaded_file is not None:
    # рокроЯродрпНродрпИродрпН родро┐ро▒роирпНродрпБ NumPy array-роХрпНроХрпБ рооро╛ро▒рпНро▒рпБ
    image_pil = Image.open(uploaded_file)
    image_array = np.array(image_pil)
    
    # RGB-ро▓ро┐ро░рпБроирпНродрпБ BGR-роХрпНроХрпБ рооро╛ро▒рпНро▒рпБ (OpenCVроХрпНроХрпБродрпН родрпЗро╡рпИ)
    image_bgr = cv2.cvtColor(image_array, cv2.COLOR_RGB2BGR)
    
    st.image(image_pil, caption="роЕроЪро▓рпН рокроЯроорпН (Original Image)", use_column_width=True)

    st.markdown("### роиро┐ро▒ рооро╛ро▒рпНро▒родрпНродро┐ро▒рпНроХро╛рой роЕроорпИрокрпНрокрпБроХро│рпН")
    hue_shift = st.slider('Hue рооро╛ро▒рпНро▒ роЕро│ро╡рпБ (Hue Shift Amount) (-180 роорпБродро▓рпН 180 ро╡ро░рпИ)', -50, 50, 15)
    
    if st.button('родрпЛро▓рпН роиро┐ро▒ рооро╛ро▒рпНро▒родрпНродрпИроЪрпН роЪрпЖропро▓рпНрокроЯрпБродрпНродрпБ (Apply Skin Tone Change)'):
        
        # роорпБроХродрпНродрпИроХрпН роХрогрпНроЯро▒ро┐ропрпБроорпН classifier-роР родрпБро╡роХрпНроХрпБродро▓рпН
        face_cascade = cv2.CascadeClassifier(CASCADES_FILE)
        
        # рокроЯродрпНродрпИроЪрпН роЪро╛роорпНрокро▓рпН роиро┐ро▒родрпНродро┐ро▒рпНроХрпБ рооро╛ро▒рпНро▒рпБродро▓рпН (роХрогрпНроЯро▒ро┐родро▓рпБроХрпНроХрпБ роОро│ро┐родро╛роХ)
        gray = cv2.cvtColor(image_bgr, cv2.COLOR_BGR2GRAY)
        
        # роорпБроХроЩрпНроХро│рпИроХрпН роХрогрпНроЯро▒ро┐родро▓рпН
        faces = face_cascade.detectMultiScale(gray, 1.3, 5)
        
        if len(faces) == 0:
            st.warning("роЗроирпНродрокрпН рокроЯродрпНродро┐ро▓рпН роорпБроХроЩрпНроХро│рпН роХрогрпНроЯро▒ро┐ропрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ. роиро┐ро▒ рооро╛ро▒рпНро▒роорпН роЪрпЖропро▓рпНрокроЯро╡ро┐ро▓рпНро▓рпИ.")
            
        else:
            processed_image = image_bgr.copy()
            st.write(f"{len(faces)} роорпБроХроЩрпНроХро│рпН роХрогрпНроЯро▒ро┐ропрокрпНрокроЯрпНроЯрой.")

            # роХрогрпНроЯро▒ро┐ропрокрпНрокроЯрпНроЯ роТро╡рпНро╡рпКро░рпБ роорпБроХродрпНродро┐ро▓рпБроорпН роЪрпЖропро▓ро╛роХрпНроХроорпН
            for (x, y, w, h) in faces:
                # роорпБроХродрпНродро┐ройрпН рокроХрпБродро┐ропрпИ роороЯрпНроЯрпБроорпН родрпБрогрпНроЯро┐родрпНродро▓рпН (ROI - Region of Interest)
                roi = processed_image[y:y+h, x:x+w]
                
                # BGR-ро▓ро┐ро░рпБроирпНродрпБ HSVроХрпНроХрпБ рооро╛ро▒рпНро▒рпБ
                hsv_roi = cv2.cvtColor(roi, cv2.COLOR_BGR2HSV)
                
                # ----------------------------------------------------
                # HSV роородро┐рокрпНрокро┐ро▓рпН Hue-роР роороЯрпНроЯрпБроорпН рооро╛ро▒рпНро▒рпБродро▓рпН
                # ----------------------------------------------------
                
                # Hue, Saturation, Value роЪрпЗройро▓рпНроХро│рпИрокрпН рокро┐ро░ро┐родрпНродро▓рпН
                h, s, v = cv2.split(hsv_roi)
                
                # Hue роородро┐рокрпНрокрпИ рооро╛ро▒рпНро▒рпБродро▓рпН
                h_new = cv2.add(h, hue_shift)
                # Hue-роР 0-179роХрпНроХрпБро│рпН ро╡рпИродрпНродро┐ро░рпБродрпНродро▓рпН (OpenCV ро╡ро┐родро┐)
                h_new = np.clip(h_new, 0, 179).astype(np.uint8)
                
                # рооро╛ро▒рпНро▒рокрпНрокроЯрпНроЯ роЪрпЗройро▓рпНроХро│рпИ роорпАрогрпНроЯрпБроорпН роЗрогрпИродрпНродро▓рпН
                new_hsv_roi = cv2.merge([h_new, s, v])
                
                # HSV-ро▓ро┐ро░рпБроирпНродрпБ роорпАрогрпНроЯрпБроорпН BGRроХрпНроХрпБ рооро╛ро▒рпНро▒рпБ
                result_bgr_roi = cv2.cvtColor(new_hsv_roi, cv2.COLOR_HSV2BGR)
                
                # рооро╛ро▒рпНро▒рокрпНрокроЯрпНроЯ роорпБроХрокрпН рокроХрпБродро┐ропрпИ роЕроЪро▓рпН рокроЯродрпНродро┐ро▒рпНроХрпБро│рпН ро╡рпИ
                processed_image[y:y+h, x:x+w] = result_bgr_roi
            
            # роЗро▒рпБродро┐рокрпН рокроЯродрпНродрпИроХрпН роХро╛роЯрпНроЯрпБродро▓рпН (BGR-ро▓ро┐ро░рпБроирпНродрпБ RGBроХрпНроХрпБ рооро╛ро▒рпНро▒ро┐)
            result_rgb = cv2.cvtColor(processed_image, cv2.COLOR_BGR2RGB)
            st.image(result_rgb, caption=f"родрпЛро▓рпН роиро┐ро▒роорпН рооро╛ро▒рпНро▒рокрпНрокроЯрпНроЯ рокроЯроорпН (Hue Shift: {hue_shift})", use_column_width=True)
            st.success("роиро┐ро▒ рооро╛ро▒рпНро▒роорпН ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХроЪрпН роЪрпЖропро▓рпНрокроЯрпБродрпНродрокрпНрокроЯрпНроЯродрпБ!")

# роЕроЯро┐роХрпНроХрпБро▒ро┐рокрпНрокрпБ
st.markdown("---")
st.warning("роЗроирпНродроХрпН роХрпБро▒ро┐ропрпАроЯрпБ роорпБроХродрпНродрпИроХрпН роХрогрпНроЯро▒ро┐роирпНрод рокроХрпБродро┐ропро┐ро▓рпН роороЯрпНроЯрпБроорпЗ роиро┐ро▒ рооро╛ро▒рпНро▒родрпНродрпИроЪрпН роЪрпЖропро▓рпНрокроЯрпБродрпНродрпБроХро┐ро▒родрпБ. роорпБро┤рпБроорпИропро╛рой родрпЛро▓рпН роиро┐ро▒рокрпН рокро┐ро░ро┐рокрпНрокрпБ (Segmentation) роЪрпЖропро▓рпНроорпБро▒рпИ роЗродро┐ро▓рпН роЗро▓рпНро▓рпИ.")

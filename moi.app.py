import streamlit as st
import pandas as pd
import sqlite3
from datetime import datetime

# --- 1. родро░ро╡рпБродрпНродро│роорпН роЕроорпИро╡рпБ роЪрпЖропро▓рпНрокро╛роЯрпБроХро│рпН (Database Setup Functions) ---

# SQLite родро░ро╡рпБродрпНродро│родрпНродрпБроЯройрпН роЗрогрпИроХрпНроХрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
@st.cache_resource # роЖрокрпН роорпБро┤рпБро╡родрпБроорпН роЗрогрпИрокрпНрокрпИродрпН родроХрпНроХро╡рпИроХрпНроХ
def init_db():
    # Streamlit Cloud-ро▓рпН роЗродрпБ роТро░рпБ родро▒рпНроХро╛ро▓ро┐роХрооро╛рой (ephemeral) родро░ро╡рпБродрпНродро│рооро╛роХ роЗро░рпБроХрпНроХрпБроорпН роОройрпНрокродрпИ роиро┐ройрпИро╡ро┐ро▓рпН роХрпКро│рпНроХ.
    # роиро┐ро░роирпНродро░ роЪрпЗрооро┐рокрпНрокро┐ро▒рпНроХрпБ Google Sheets роЕро▓рпНро▓родрпБ ро╡рпЖро│ро┐рокрпНрокрпБро▒ DB родрпЗро╡рпИ.
    conn = sqlite3.connect('moi_register.db')
    c = conn.cursor()
    c.execute('''
        CREATE TABLE IF NOT EXISTS moi_entries (
            id INTEGER PRIMARY KEY,
            name TEXT NOT NULL,
            amount REAL NOT NULL,
            date_time TEXT NOT NULL,
            notes TEXT
        )
    ''')
    conn.commit()
    return conn

# роорпКропрпН рокродро┐ро╡рпИроЪрпН роЪрпЗрооро┐роХрпНроХрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
def add_moi_entry(conn, name, amount, notes=""):
    date_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    c = conn.cursor()
    c.execute("INSERT INTO moi_entries (name, amount, date_time, notes) VALUES (?, ?, ?, ?)",
              (name, amount, date_time, notes))
    conn.commit()

# роЕройрпИродрпНродрпБрокрпН рокродро┐ро╡рпБроХро│рпИропрпБроорпН роОроЯрпБроХрпНроХрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
def get_all_entries(conn):
    c = conn.cursor()
    c.execute("SELECT name, amount, date_time, notes FROM moi_entries ORDER BY date_time DESC")
    return c.fetchall()

# --- 2. Streamlit UI (рокропройро░рпН роЗроЯрпИроорпБроХроорпН) ---

# родро░ро╡рпБродрпНродро│ роЗрогрпИрокрпНрокрпИродрпН родрпБро╡роХрпНроХрпБроХ
conn = init_db()

# роЖрокрпНрокро┐ройрпН родро▓рпИрокрпНрокрпБ рооро▒рпНро▒рпБроорпН родроХро╡ро▓рпН
st.title("ЁЯТ░ роорпКропрпН рокродро┐ро╡рпБрокрпН рокрпБродрпНродроХроорпН (MoI Register)")
st.caption("Streamlit & SQLite роЖро▓рпН роЙро░рпБро╡ро╛роХрпНроХрокрпНрокроЯрпНроЯродрпБ")

# --- роЙро│рпНро│рпАроЯрпНроЯрпБрокрпН рокроЯро┐ро╡роорпН (Input Form) ---
st.header("тЮХ рокрпБродро┐роп роорпКропрпН рокродро┐ро╡рпБ")

# Streamlit Form рокропройрпНрокроЯрпБродрпНродро┐, роТро░рпЗ роирпЗро░родрпНродро┐ро▓рпН рокро▓ роЙро│рпНро│рпАроЯрпБроХро│рпИ роЪрооро░рпНрокрпНрокро┐роХрпНроХро▓ро╛роорпН
with st.form(key='moi_form'):
    col1, col2 = st.columns(2)
    
    with col1:
        # роХрпКроЯрпБродрпНродро╡ро░рпН рокрпЖропро░рпН (роорпКрокрпИро▓ро┐ро▓рпН Voice Typing рокропройрпНрокроЯрпБродрпНродро▓ро╛роорпН)
        name = st.text_input("рокрпЖропро░рпН", max_chars=100)
    
    with col2:
        # роХрпКроЯрпБродрпНрод родрпКроХрпИ
        amount = st.number_input("родрпКроХрпИ (тВ╣)", min_value=0.0, value=0.0, step=100.0)
        
    # роХрпВроЯрпБродро▓рпН роХрпБро▒ро┐рокрпНрокрпБроХро│рпН
    notes = st.text_area("роХрпБро▒ро┐рокрпНрокрпБроХро│рпН (Optional)")
    
    # роЪрооро░рпНрокрпНрокро┐роХрпНроХрпБроорпН рокроЯрпНроЯройрпН
    submit_button = st.form_submit_button(label='рокродро┐ро╡рпБ роЪрпЖропрпН')

# рокроЯро┐ро╡роорпН роЪрооро░рпНрокрпНрокро┐роХрпНроХрокрпНрокроЯрпНроЯро╛ро▓рпН...
if submit_button:
    if name and amount > 0:
        add_moi_entry(conn, name, amount, notes)
        st.success(f"тЬЕ тВ╣{amount:,.2f} родрпКроХрпИ **{name}** роОройрпНрокро╡ро░ро╛ро▓рпН ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХрокрпН рокродро┐ро╡рпБ роЪрпЖропрпНропрокрпНрокроЯрпНроЯродрпБ!")
        # ро╡рпЖро▒рпНро▒ро┐роХрпНроХрпБрокрпН рокро┐ройрпН родро╛ройро╛роХ ро░рпАроГрокрпНро░рпЖро╖рпН роЪрпЖропрпНроп
        st.experimental_rerun() 
    else:
        st.error("тЭМ рокрпЖропро░рпН рооро▒рпНро▒рпБроорпН роЪро░ро┐ропро╛рой родрпКроХрпИ роХроЯрпНроЯро╛ропроорпН родрпЗро╡рпИ!")


# --- 3. родро░ро╡рпБ роХро╛роЯрпНроЪро┐рокрпНрокроЯрпБродрпНродро▓рпН (Data Visualization) ---

st.header("ЁЯУЦ рокродро┐ро╡рпБроХро│рпН рооро▒рпНро▒рпБроорпН роорпКродрпНродроХрпН роХрогроХрпНроХрпБ")

# роЕройрпИродрпНродрпБрокрпН рокродро┐ро╡рпБроХро│рпИропрпБроорпН родро░ро╡рпБродрпНродро│родрпНродро┐ро▓рпН роЗро░рпБроирпНродрпБ роОроЯрпБроХрпНроХро╡рпБроорпН
raw_data = get_all_entries(conn)

if raw_data:
    # pandas DataFrame роЖроХ рооро╛ро▒рпНро▒рпБродро▓рпН
    df = pd.DataFrame(raw_data, columns=["рокрпЖропро░рпН", "родрпКроХрпИ (тВ╣)", "роирпЗро░роорпН", "роХрпБро▒ро┐рокрпНрокрпБроХро│рпН"])

    # роорпКродрпНродродрпН родрпКроХрпИропрпИроХрпН роХрогроХрпНроХро┐роЯрпБродро▓рпН
    total_moi = df["родрпКроХрпИ (тВ╣)"].sum()
    st.metric("роорпКродрпНрод роорпКропрпН ро╡ро░ро╡рпБ", value=f"тВ╣ {total_moi:,.2f}")
    
    st.markdown("---")
    
    # родрпЗроЯро▓рпН рокроЯрпНроЯро┐
    search_term = st.text_input("рокрпЖропро░рпН роорпВро▓роорпН родрпЗроЯро╡рпБроорпН", "")
    
    # родрпЗроЯро▓рпН ро╡роЯро┐роХроЯрпНроЯрпБродро▓рпН (Filtering)
    if search_term:
        # родрпЗроЯро▓рпН роЪрпКро▓рпНро▓рпИроХрпН роХрпКрогрпНроЯрпБ рокрпЖропро░рпНроХро│рпИ ро╡роЯро┐роХрпНроХроЯрпНроЯро╡рпБроорпН (Case-insensitive)
        df_filtered = df[df["рокрпЖропро░рпН"].str.contains(search_term, case=False, na=False)]
    else:
        df_filtered = df
        
    # ро╡роЯро┐роХроЯрпНроЯрокрпНрокроЯрпНроЯ роЯрпЗроЯрпНроЯро╛ро╡рпИ роЕроЯрпНроЯро╡рогрпИропро╛роХроХрпН роХро╛роЯрпНроЯрпБродро▓рпН
    st.dataframe(df_filtered, use_container_width=True)

    # роЕро▒ро┐роХрпНроХрпИропро╛роХ роПро▒рпНро▒рпБроородро┐ (Download) роЪрпЖропрпНроп роТро░рпБ рокроЯрпНроЯройрпН
    # DataFrame-роР CSV роЖроХ рооро╛ро▒рпНро▒рпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    csv = df.to_csv(index=False).encode('utf-8')
    st.download_button(
        label="Download родро░ро╡рпБроХро│рпИ CSV роЖроХ",
        data=csv,
        file_name='moi_register_export.csv',
        mime='text/csv',
    )
    
else:
    st.info("роЗройрпНройрпБроорпН роОроирпНрод роорпКропрпН рокродро┐ро╡рпБроХро│рпБроорпН роЪрпЖропрпНропрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ.")
